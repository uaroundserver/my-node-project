<!-- public/chat.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="chat.css">
   <link rel="stylesheet" href="mobile-only.css" media="screen and (min-width: 481px)">
</head>
<body>
  <div id="chat-app" class="chat-app">
    <aside class="chat-list">
      <header class="list-header">
        <h2>–ß–∞—Ç—ã</h2>
      </header>
      <ul id="chatList"></ul>
    </aside>

    <main class="chat-main">

      <!-- –®–∞–ø–∫–∞ -->
      <header class="chat-header">
        <button id="tgBack" class="back-btn" type="button" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
        <div id="tgTitle" class="chat-title">General chat</div>
        <div id="tgSub" class="chat-typing"></div>

        <!-- –∞–≤–∞—Ç–∞—Ä —Å–ø—Ä–∞–≤–∞ -->
        <img id="tgAvatarImg" class="chat-avatar" alt="" />
        <span id="tgAvatarLetter" class="chat-avatar chat-avatar-letter" style="display:none">G</span>

        <!-- –ü–æ–∏—Å–∫ -->
        <input id="tgSearch" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç—É"/>
      </header>

      <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
      <section id="messageList" class="messages"></section>

      <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ -->
      <div id="replyBar" class="reply-bar" hidden>
        <span id="replyText"></span>
        <button id="replyCancel" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚úï</button>
      </div>

      <!-- Composer -->
      <footer class="composer">
        <div class="composer-left">
          <button id="attachBtn" title="–í–ª–æ–∂–µ–Ω–∏—è">üìé</button>
          <input id="fileInput" type="file" multiple hidden />
        </div>
        <textarea id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" rows="1"></textarea>
        <div class="composer-right">
          <button id="emojiBtn" title="–°–º–∞–π–ª—ã">üòä</button>
          <button id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
      </footer>
    </main>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="scripts/chat.js"></script>


<script>
window.authToken     = localStorage.getItem('userToken') || localStorage.getItem('token') || '';
  window.currentChatId  = "66c21f4f9f6b0f93d4b12345"; // –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π ID
window.currentUserId = localStorage.getItem('userId')    || '';

async function ensureChatId(){
  if (window.currentChatId) return;
  const res = await fetch('/api/chat/chats', { headers: { Authorization: 'Bearer ' + window.authToken } });
  if (!res.ok) throw new Error('–ù–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å —á–∞—Ç—ã: ' + res.status);
  const arr = await res.json();
  window.currentChatId = arr?.[0]?._id || '';
}


  const MSG_BOX_ID = 'messageList';
  let skip = 0;
  const limit = 30;
  let loading = false;

  function el(tag, cls, text){
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (text != null) n.textContent = text;
    return n;
  }

  function renderMessage(msg){
    const mine = window.currentUserId && String(msg.senderId) === String(window.currentUserId);

    const wrap   = el('div', 'message' + (mine ? ' mine' : ''));
    const bubble = el('div', 'msg ' + (mine ? 'mine' : 'their'));

    const mrow = el('div', 'mrow');
    const name = el('div', 'mname', mine ? '–í—ã' : (msg.senderName || '–ì–æ—Å—Ç—å'));
    mrow.appendChild(name);

    const mbody = el('div', 'mbody');
    const text  = el('div', 'mtext', msg.text || (msg.attachments?.length ? '–í–ª–æ–∂–µ–Ω–∏–µ' : ''));

    const meta = el('div', 'mmeta');
    const time = el('span', '', new Date(msg.createdAt).toLocaleTimeString().slice(0,5));
    meta.appendChild(time);

    mbody.appendChild(mrow);
    mbody.appendChild(text);

    bubble.appendChild(mbody);
    bubble.appendChild(meta);
    wrap.appendChild(bubble);
    return wrap;
  }

  function box(){ return document.getElementById(MSG_BOX_ID); }

  function scrollToBottom(){
    const b = box();
    b.scrollTop = b.scrollHeight;
  }

  async function loadMessages(chatId, append = false){
    if (loading) return;
    loading = true;

    const headers = {};
    if (window.authToken) headers['Authorization'] = 'Bearer ' + window.authToken;

    const res = await fetch(`/api/chat/messages?chatId=${encodeURIComponent(chatId)}&limit=${limit}&skip=${skip}`, { headers });
    if (!res.ok){
      console.error('Failed to load messages', await res.text());
      loading = false;
      return;
    }

    const list = await res.json();
    if (!list.length){
      loading = false;
      return; // –±–æ–ª—å—à–µ –Ω–µ—á–µ–≥–æ –≥—Ä—É–∑–∏—Ç—å
    }

    const b = box();

    if (append){ 
      const oldScrollHeight = b.scrollHeight;
      const first = b.firstChild;
      list.forEach(msg => b.insertBefore(renderMessage(msg), first));
      b.scrollTop = b.scrollHeight - oldScrollHeight;
    } else {
      b.innerHTML = '';
      list.forEach(msg => b.appendChild(renderMessage(msg)));
      scrollToBottom();
    }

    skip += list.length;
    loading = false;
  }

  // === –ó–∞–ø—É—Å–∫ ===
  document.addEventListener('DOMContentLoaded', () => {
    if (!window.currentChatId) {
      console.warn('currentChatId –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–¥—Å—Ç–∞–≤—å _id —á–∞—Ç–∞');
      return;
    }
    loadMessages(window.currentChatId); // –ø–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

    // –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≤–≤–µ—Ä—Ö –≥—Ä—É–∑–∏–º —Å—Ç–∞—Ä—ã–µ
    box().addEventListener("scroll", () => {
      if (box().scrollTop < 100) {
        loadMessages(window.currentChatId, true);
      }
    });
  });

  // === –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ socket.io ===
  if (window.io){
    const socket = io({ auth: { token: window.authToken ? ('Bearer ' + window.authToken) : undefined } });
    socket.on('message:new', (msg) => {
      const b = box();
      const stick = (b.scrollHeight - (b.scrollTop + b.clientHeight)) <= 80;
      b.appendChild(renderMessage(msg));
      if (stick) scrollToBottom();
    });
  }
</script>


</script>
</body>
</html>
