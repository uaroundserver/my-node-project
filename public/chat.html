<!-- public/chat.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="chat.css">
   <link rel="stylesheet" href="mobile-only.css" media="screen and (min-width: 481px)">
</head>
<body>
  <div id="chat-app" class="chat-app">
    <aside class="chat-list">
      <header class="list-header">
        <h2>–ß–∞—Ç—ã</h2>
      </header>
      <ul id="chatList"></ul>
    </aside>

    <main class="chat-main">

      <!-- –®–∞–ø–∫–∞ -->
      <header class="chat-header">
        <button id="tgBack" class="back-btn" type="button" aria-label="–ù–∞–∑–∞–¥">‚Üê</button>
        <div id="tgTitle" class="chat-title">General chat</div>
        <div id="tgSub" class="chat-typing"></div>

        <!-- –∞–≤–∞—Ç–∞—Ä —Å–ø—Ä–∞–≤–∞ -->
        <img id="tgAvatarImg" class="chat-avatar" alt="" />
        <span id="tgAvatarLetter" class="chat-avatar chat-avatar-letter" style="display:none">G</span>

        <!-- –ü–æ–∏—Å–∫ -->
        <input id="tgSearch" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç—É"/>
      </header>

      <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
      <section id="messageList" class="messages"></section>

      <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ -->
      <div id="replyBar" class="reply-bar" hidden>
        <span id="replyText"></span>
        <button id="replyCancel" title="–û—Ç–º–µ–Ω–∏—Ç—å">‚úï</button>
      </div>

      <!-- Composer -->
      <footer class="composer">
        <div class="composer-left">
          <button id="attachBtn" title="–í–ª–æ–∂–µ–Ω–∏—è">üìé</button>
          <input id="fileInput" type="file" multiple hidden />
        </div>
        <textarea id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" rows="1"></textarea>
        <div class="composer-right">
          <button id="emojiBtn" title="–°–º–∞–π–ª—ã">üòä</button>
          <button id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
      </footer>
    </main>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="scripts/chat.js"></script>
  <script>
let chatId = null;
let messages = [];
let isLoading = false;
let reachedTop = false;

// –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–∏ –≤—Ö–æ–¥–µ)
async function loadInitialMessages() {
  const token = localStorage.getItem('userToken');
  const res = await fetch(`/api/chat/messages?chatId=${chatId}&limit=50`, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await res.json();
  messages = data;
  renderMessages();
  scrollToBottom();
}

// –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function loadMoreMessages() {
  if (isLoading || reachedTop) return;
  if (!messages.length) return;
  isLoading = true;

  const firstMsg = messages[0];
  const token = localStorage.getItem('userToken');
  const res = await fetch(`/api/chat/messages?chatId=${chatId}&before=${firstMsg.createdAt}&limit=50`, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await res.json();

  if (data.length === 0) {
    reachedTop = true; // –±–æ–ª—å—à–µ —Å—Ç–∞—Ä—ã—Ö –Ω–µ—Ç
  } else {
    messages = [...data, ...messages]; // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ
    renderMessages(true, data.length);
  }

  isLoading = false;
}

// —Ä–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
function renderMessages(keepScroll = false, addedCount = 0) {
  const container = document.getElementById('messageList');
  container.innerHTML = messages.map(m => `
    <div class="msg">
      <b>${m.senderName}</b>: ${m.text}
    </div>
  `).join('');

  if (keepScroll) {
    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å–≤–µ—Ä—Ö—É
    const prevHeight = container.scrollHeight;
    setTimeout(() => {
      const newHeight = container.scrollHeight;
      container.scrollTop = newHeight - prevHeight;
    }, 0);
  }
}

// –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ (–ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —á–∞—Ç)
function scrollToBottom() {
  const container = document.getElementById('messageList');
  container.scrollTop = container.scrollHeight;
}

// —Å–ª–µ–¥–∏–º –∑–∞ —Å–∫—Ä–æ–ª–ª–æ–º, –µ—Å–ª–∏ –¥–æ—à–ª–∏ –≤–≤–µ—Ä—Ö ‚Üí –ø–æ–¥–≥—Ä—É–∂–∞–µ–º
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('messageList');
  container.addEventListener('scroll', () => {
    if (container.scrollTop < 50) {
      loadMoreMessages();
    }
  });
});

// üëâ –ø—Ä–∏ –∑–∞—Ö–æ–¥–µ –≤ —á–∞—Ç –ø–æ–¥—Å—Ç–∞–≤—å chatId –∏ –∑–∞–≥—Ä—É–∑–∏ –Ω–∞—á–∞–ª—å–Ω—ã–µ
chatId = "ID_–¢–í–û–ï–ì–û_–ì–õ–û–ë–ê–õ–¨–ù–û–ì–û_–ß–ê–¢–ê"; 
loadInitialMessages();


<script>
  window.authToken      = window.authToken      || '';   // Bearer-—Ç–æ–∫–µ–Ω
  window.currentChatId  = window.currentChatId  || '';   // _id —á–∞—Ç–∞
  window.currentUserId  = window.currentUserId  || '';   // _id —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞

  const MSG_BOX_ID = 'messageList';
  const PAGE_SIZE  = 50;   // —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≥—Ä—É–∑–∏—Ç—å –∑–∞ —Ä–∞–∑

  function el(tag, cls, text){
    const n = document.createElement(tag);
    if (cls) n.className = cls;
    if (text != null) n.textContent = text;
    return n;
  }

  function renderMessage(msg){
    const mine = window.currentUserId && String(msg.senderId) === String(window.currentUserId);

    const wrap   = el('div', 'message' + (mine ? ' mine' : ''));
    wrap.dataset.createdAt = msg.createdAt;

    const bubble = el('div', 'msg ' + (mine ? 'mine' : 'their'));

    const mrow = el('div', 'mrow');
    const name = el('div', 'mname', mine ? '–í—ã' : (msg.senderName || '–ì–æ—Å—Ç—å'));
    mrow.appendChild(name);

    const mbody = el('div', 'mbody');
    const text  = el('div', 'mtext', msg.text || (msg.attachments?.length ? '–í–ª–æ–∂–µ–Ω–∏–µ' : ''));

    const meta = el('div', 'mmeta');
    const time = el('span', '', new Date(msg.createdAt).toLocaleTimeString().slice(0,5));
    meta.appendChild(time);

    mbody.appendChild(mrow);
    mbody.appendChild(text);

    bubble.appendChild(mbody);
    bubble.appendChild(meta);
    wrap.appendChild(bubble);
    return wrap;
  }

  function box(){ return document.getElementById(MSG_BOX_ID); }

  function isNearBottom(px = 80){
    const b = box();
    return (b.scrollHeight - (b.scrollTop + b.clientHeight)) <= px;
  }

  function scrollToBottom(){
    const b = box();
    b.scrollTop = b.scrollHeight;
  }

  // === API ===
  async function fetchMessages(chatId, { before } = {}){
    const headers = {};
    if (window.authToken) headers['Authorization'] = 'Bearer ' + window.authToken;

    let url = `/api/chat/messages?chatId=${encodeURIComponent(chatId)}&limit=${PAGE_SIZE}`;
    if (before) url += `&before=${encodeURIComponent(before)}`;

    const res = await fetch(url, { headers });
    if (!res.ok) {
      console.error('Failed to load messages', await res.text());
      return [];
    }
    return await res.json();
  }

  // === –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
  async function loadInitial(){
    const list = await fetchMessages(window.currentChatId);
    const b = box();
    b.innerHTML = '';
    for (const msg of list){
      b.appendChild(renderMessage(msg));
    }
    scrollToBottom();
  }

  // === –ü–ª–∞–≤–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –≤–≤–µ—Ä—Ö ===
  let loading = false;
  async function loadMoreIfNeeded(){
    const b = box();
    if (b.scrollTop < 200 && !loading){   // –ø–æ—á—Ç–∏ –¥–æ—à–ª–∏ –¥–æ –≤–µ—Ä—Ö–∞
      loading = true;

      const oldHeight = b.scrollHeight;
      const firstMsg  = b.querySelector(".message:first-child");
      const before    = firstMsg?.dataset.createdAt;

      if (!before){ loading = false; return; }

      const more = await fetchMessages(window.currentChatId, { before });

      for (let i = more.length - 1; i >= 0; i--){
        const m = renderMessage(more[i]);
        b.insertBefore(m, b.firstChild);
      }

      // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é (—á—Ç–æ–±—ã —Å–∫—Ä–æ–ª–ª –Ω–µ –ø—Ä—ã–≥–∞–ª)
      const newHeight = b.scrollHeight;
      b.scrollTop = newHeight - oldHeight + b.scrollTop;

      loading = false;
    }
  }

  // === –ó–∞–ø—É—Å–∫ ===
  document.addEventListener('DOMContentLoaded', () => {
    if (!window.currentChatId) {
      console.warn('currentChatId –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–¥—Å—Ç–∞–≤—å _id —á–∞—Ç–∞');
      return;
    }
    loadInitial();

    box().addEventListener("scroll", loadMoreIfNeeded);
  });

  // === –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ socket.io ===
  if (window.io){
    const socket = io({ auth: { token: window.authToken ? ('Bearer ' + window.authToken) : undefined } });
    socket.on('message:new', (msg) => {
      const stick = isNearBottom();
      box().appendChild(renderMessage(msg));
      if (stick) scrollToBottom();
    });
  }
</script>


</script>
</body>
</html>
